<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增/編輯公告</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        div {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            color: #555;
        }
        input[type="text"],
        input[type="datetime-local"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div>
        <h1>新增/編輯公告</h1>
        <form id="announcement-form" enctype="multipart/form-data">
            <label for="title">公告標題:</label>
            <input type="text" id="title" name="title" required>

            <label for="context">內文:</label>
            <div id="editor" style="height: 300px;"></div>
            <input type="hidden" id="context" name="context">

            <label for="image">封面縮圖:</label>
            <input type="file" id="image" name="image" accept="image/*">

            <label for="timeOn">上架時間:</label>
            <input type="datetime-local" id="timeOn" name="timeOn" required>

            <label for="timeOff">下架時間:</label>
            <input type="datetime-local" id="timeOff" name="timeOff" required>

            <label for="hyperlink">超連結:</label>
            <input type="text" id="hyperlink" name="hyperlink">

            <button type="submit">提交</button>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        ['image', 'code-block']
                    ]
                }
            });

            function imageHandler() {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');
                input.click();

                input.onchange = () => {
                    const file = input.files[0];
                    if (file) {
                        const formData = new FormData();
                        formData.append('upload', file);

                        fetch('http://localhost:3001/api/upload', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.uploaded) {
                                const range = quill.getSelection();
                                quill.insertEmbed(range.index, 'image', result.url);
                            } else {
                                alert('圖片上傳失敗');
                            }
                        })
                        .catch(() => alert('圖片上傳失敗'));
                    }
                };
            }

            quill.getModule('toolbar').addHandler('image', imageHandler);

            function toDatetimeLocal(date) {
                const ten = function (i) {
                    return (i < 10 ? '0' : '') + i;
                };
                const YYYY = date.getFullYear();
                const MM = ten(date.getMonth() + 1);
                const DD = ten(date.getDate());
                const HH = ten(date.getHours());
                const II = ten(date.getMinutes());
                return YYYY + '-' + MM + '-' + DD + 'T' + HH + ':' + II;
            }

            function setDefaultTimes() {
                const now = new Date();
                now.setMinutes(0, 0, 0); // 將分鐘和秒設為00
                const oneDayLater = new Date(now.getTime() + 24 * 60 * 60 * 1000);

                const timeOn = document.getElementById('timeOn');
                const timeOff = document.getElementById('timeOff');
                
                // 只對下架時間設置最小值
                timeOff.min = toDatetimeLocal(now);

                timeOn.value = toDatetimeLocal(now);
                timeOff.value = toDatetimeLocal(oneDayLater);
            }

            function checkTimeValidity() {
                const timeOn = new Date(document.getElementById('timeOn').value);
                const timeOff = new Date(document.getElementById('timeOff').value);

                if (timeOff <= timeOn) {
                    alert('下架時間必須晚於上架時間。');
                    document.getElementById('timeOff').focus(); // 設置焦點到下架時間輸入框
                    return false;
                }

                return true;
            }

            const form = document.getElementById('announcement-form');
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            if (id) {
                fetch(`http://localhost:3001/api/announcements/${id}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('title').value = data.title;
                        quill.root.innerHTML = data.context;
                        document.getElementById('hyperlink').value = data.hyperlink;
                        document.getElementById('timeOn').value = toDatetimeLocal(new Date(data.timeOn));
                        document.getElementById('timeOff').value = toDatetimeLocal(new Date(data.timeOff));
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('加載公告時出錯');
                    });
            } else {
                setDefaultTimes();
            }

            form.addEventListener('submit', function(event) {
                event.preventDefault();

                if (!checkTimeValidity()) {
                    return; // 時間無效，阻止表單提交
                }

                const formData = new FormData(form);
                const editorContent = quill.root.innerHTML;
                formData.set('context', editorContent);

                const method = id ? 'PUT' : 'POST';
                const url = id ? `http://localhost:3001/api/announcements/${id}` : 'http://localhost:3001/api/announcements';

                fetch(url, {
                    method: method,
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('公告已成功提交並儲存為 JSON 檔案！');
                        window.location.href = 'enterprise-related.html';
                    } else {
                        alert('提交失敗，請重試。');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('提交失敗，請重試。');
                });
            });
        });
    </script>
</body>
</html>
